import {fzf} from "/home/kdog3682/2024-javascript/lib/fzf.js"
window["fzf"] = fzf

import Vue from "/home/kdog3682/2024-javascript/lib/vue.js"
import {VCheckbox, VIframe, VDate, VEnum, VHtml, VIcon, VImg, VInfo, VInlineCode, VInput, VInput2, VItem, VList, VLorem, VPre, VSkeleton, VSlider, VTable} from "/home/kdog3682/2024-javascript/vuekit/base-components.js"
/* deno-fmt-ignore */ import {fooga, denoDebug, isAbsolutePath, templater3, splitInHalf, pop4, map4, visit, AbstractVisitor, shellEscape, getkv, toggleBooleanState, numbered, noidea, assertObjectValue, assertValue, getClasses, exit, choose, getFileName, testEqual, pause, getBindingValueString, templater2, smartDedent5, pop3, moduleExports, joinPath, expandPath, isDecimal, hasPercentage, ass, parsePercentage, Matrix, isInteger, isEquation, isObjectObject, getExtraIndent, shellUnescape, assertEqual, asyncToggle, touched, chosen, lastOf, firstOf, isBlockEnter, group3, loremIpsum, exportString, deepToggle, maybeNewlineIndent, onAndOff, flattenModule, isModule, isNativeHtmlTag, partitionByValues, strcall, getLongest2, must, mconfig, unreachable, storager, joiner, removeVeryStartingComments, ireplace, removeCommentsInPlace, editf, getLineTokens, IndexedStore, abstractError, bool, xassert, getSetLines, inMiddle, replaceLast, ensureExtension, multipleReplacer, getGradeLevel, constructEdit, getYear, Modulus, wrapClassMethods, proseReplacer, parseComments, parseFunctionDictComments, todo, dictAssertion, boundModularIncrement, construct, reduceToString2, pageTurner, assignCumulative, defaultMergeStrategy, dictSetter3, toArguments, reTemplate, parseFrontmatter, typeAssertion, defineGetter, assignAllowed, simpleRecursiveWalk, simpleArgument, exprTemplater, stringifyIfNotPrimitive, panic, stringerf, wrapFunction, regexTemplater, iso8601, strftime, walkChildEntries, getFiletype, matchf, isUrl, looksLikeFunction, toArgument2, notNull, CumulativeStorage2, simpleAssign, findAndMatch, infuseObjectArray, regexGetter, splitArg, isJavascriptComment, runTest, everyOther, splitByRange, get_regex, getImports, isJavascriptFile, isValidDateString, WriteObject, equalityf, group2, splitOnce2, dedent4, isLowerCase, looksLikeRegExpString, isRegExpString, getDependencies, camelSplit, toggle3, countf, isLiteralObject, bindMethodsAndState2, call, mget3, looks_like_object_function, create_functions_from_master, toStringArgumentPretty, codeChunks, smart_map, run_tests, hasStartingCallable, mapTemplate, aliaser, fixSelector, htmlTags, removePythonComments, simpleStringBreaker, colonConfig, operations, error, redColon, so2, group, parseSingleLineJson, Items, findDependencies, tryf, find4, localeString, cssComment, colonConfigf, trimArray, parseCallable, bringToLifeTextFix, localBringToLife, getCaller4, getErrorStack, forEach, getBindings, getExports, matchstr, filter4, allEqual, count, isNativeFunction, repeat, eat, getIndentAndText, StopWatch, stringDictSetter, getFunctionInfo, runRef, toLines, hasCallable, getProseWords, tally, paramify, codeSplit, debugConfig, logConfig, blueColon, toStringArgument3, stringCallable, simpleBinding, dashSplit4, appendBelow, appendAbove, removeLineComments, prependIfNecessary, smartDedent4, blueSandwich, walk4, findLineIndex, parseAB, applyTransform, kebabCase, getExcerpt, sortObject, buildFunction, maybeSort, parseFunction, isTypable, frontMatter, dictEntry, insertAfterIndex, State, bindMethods, cpop, tagRE, toggle2, createFunction2, assignIncrementedIndex, ufa, assignArray, regexFromComment, createParsersFromObject, imatch, globalConsoleDebug, bindMethodsAndState, isQuestion, oxfordComma, isUpperCase, getFunctionIdentifier, filter3, match, getMatch, alternatef, reCombine, assertion2, deepEqual, hasDollar, so, deepAssign, Tally, getFunctionNames, throwError, notEqual, tryString, prettyPrintCodeSnippet, prettyPrintErrorStack, iter, quotify, transformerf, assign, defineBinding, jspy, linebreak, stringCall2, reduce3, getClassParameters, assignOnTop2, isIdentifier, ndy, dashSplit3, runFunctionFromRef, equalf, alphabet, stateGetterFromSchema, mreplace, require, topLineComment, isChinese, replacef, ignoref, codeLibrary, splitLines, addArgumentQuotes, getBindings2, addCaret, mget2, getStartingConfig, incrementalEat, strlen, hr, setOnce, unescapeHtml, oxford, breakerf, runTests, map3, dateSplit, transformDict, walk3, toRegExp, tryAgainf, assertNotNull, getArgumentObject, isArgumentObject, typef, requireArg, keyAndValue, assignf, stateGetter3, objectFromArguments2, assignDefaults, transformValue, assign3, assignFresh3, evaluate3, scopedEvaluator, objectFromArguments, enforce, sub, filterObject, extractStartingJsonLikeConfig, unbrackify, newlineIndent2, deleteLine, both, normalizeIndent, getComment, secondComment, isStringRegExp, dashSplit2, clock, warning, errorStringify, alert, labelCase, bottomComment, stringCompose, getAnyIdentifier, chalkf, getNumbers, partitions, has, addUnit, toCallable, unquote, filter2, warn2, join2, caller2, assignOnce, longShort, shortLong, argPop, caller, assignOnTop, toggle, defineWindow, unescapeNewlines, escapeQuotes, unescapeQuotes, escapeNewlines, setAliases, announceCaller, removeStartingComments, smartBind, assignExisting, isObjectWithKey, eatStart, modularIncrementItem, getRegex, runFunction, isObjectLikeArray, itemGetter2, getAllKeys, prefixSlice, hasQuotes, assertion, diff, toggleState, initState, dunder, objectGetter, superTransform, popFilter, testRunner, assert2, insertAtDollar, popEmptyLine, getOptions, mergeSpecs, sortByKeys, map2, strictMessengerAssert, smartSplit, chalk4, typeLog, getFunctionName, Clock, search3, MyError, fuzzyMatch3, debugDisplay, getCaller3, messengerAssert, camelSlice, setPrototype, assignAliases, display, modifyNumber, toDict, setPush, modularIncrementIndex, longstamp, popIndex, toggleOnOff, locWrap, walk2, typeMatch, prettyStringify, getIdentifiers, CustomError, argMatch, brackify2, smartestDedent, modularIncrementNumber, AbstractMethodError, allUnique, Trie, boundarySplit, numberBoundarySplit, nodeLog, getFirst, defineProperty, supermix, partial, timeLog, timestamp, raise, getIdentifier, conditionalPrefix, conditionalSuffix, QueryList, fuzzyMatch2, buildDict, getTextAndCommand, sprawlFactory, getParameters2, pushf, intersection, union, blue, green, sandwich, getLastSpaces, smartDedent3, red, sort, debounce, checkValue, getCodeChunks, logf, boundary, myError, conditional, isStringFunction, toSpaces, objectf, searchAll, difference, singleQuote, itemGetter, slice2, mergeObjects, once, dashSplit, nchalk, coerceToObject, ArrayState, exporter2, indent2, iterator, removeAllComments, countParams, cumulativeSchemaAssign, argKwargSplit, argParse, removeInlineComments, getFrontMatter, hasHtmlSuffix, lazyArray, isThisFunction, escapeHTML, getKwargs2, search2, toStringArgument, createFuzzyMatch, edit2, splice, zip, merge2, argArgsKwargs, fill2, chalk, vueWrap, splitArray, splitArray2, warn, makeRunner2, searchf2, smartDedent2, dedent2, toArray2, stateGetter2, sortByIndex, IndexedCache, argo, curry2, doUntil2, evaluate2, findall2, findIndex2, findItem2, getCaller2, getErrorStack2, isJson, indexGetter2, insert2, pop2, parseError2, remove2, reduce2, testf2, type2, unshift2, waterfall2, xsplit2, Cache, cumulativeAssign, replaceBefore, topComment, isAsyncFunction, mapSort, getFileURI, getQuotes, isClassObject, isInitialized, getFallback, bindingRE, addObjectOrObjectProperty, forDoubles, isCss, log, iterate, backAndForth, round, iteratorWrapper, toJSON, isFromMap, toString, empty, conditionalString, getConfigArg, hasKey, errorWrap, successWrap, check, toPoints, bind, mixinAliases, isPercentage, isBasicType, reducerStrategy, gather, entries, stateGetter, methodCase, vueCase, push2, smarterIndent, lineSplit, Store, isSingleLetter, prepareText, isSymbol, getShortest, slice, KeyError, deepCopy, argsKwargs, isError, isColor, list, objectEditor, matchall, makeFastRunner, announce, hasLetter, filter, reduce, stringCall, capitalizeName, stop, proseCase, lineDitto, mixinSetters, modularIncrement, distinct, definedSort, groupBy, reWrap2, fuzzyMatch, isPlural, Element, parseError, isPrimitiveArray, callableArgsKwargs, waterfall, defineVariable, info, flat2D, splitThePage, handleError, dedent, TypeAssertion, createFunction, pluralize, remove, Group, PageStorage, Storage, UniqueStorage, Watcher, arrayToDict, addProperty, addQuotes, argWrapFactory, assert, abrev, abf, addExtension, assignFresh, antif, atFirst, atSecond, backspace, bindObject, breaker, blockQuote, brackify, bringToLife, comment, countCaptureGroups, capitalizeTitle, classMixin, callableRE, camelToTitle, curry, createVariable, changeExtension, curryStart, curryEnd, capitalize, copy, camelCase, compose, char2n, camelToDash, deepMerge, datestamp, doublef, dictSetter, dictSetter2, dsearch, doUntil, dashCase, doubleQuote, dict, dictGetter, depluralize, dreplace, dictf, endsWithWord, exporter, edit, exists, evaluate, extend, find, flatMap, fill, fixUrl, functionGetter, findall, fixPath, flat, fparse, findIndex, firstLine, ftest, getKwargs, getFirstName, getBindingName, getParameters, getLastWord, getCodeWords, getCodeWords2, getIndent, getExtension, getLast, getLongest, getChunks, getCaller, getStackTrace, getConstructorName, getFirstWord, getWords, getSpaces, hasComma, hasSpaces, hasHtml, hasBracket, hasNewline, hasCaptureGroup, hasEquals, hasValue, hasCamelCase, hasNumber, hackReplace, insert, indexGetter, incrementf, isCallable, isQuote, isEven, isOdd, isLast, isHTML, isNode, interweave, inferLang, isString, isArray, isObject, isDefined, isFunction, isPrimitive, isNumber, isSet, isNestedArray, indent, isNull, isWord, isBoolean, isRegExp, identity, isObjectLiteral, isJsonParsable, isCapitalized, isNewLine, isObjectArray, isStringArray, isClassFunction, joinSpaces, join, keyArrayToObject, lowerCase, linebreakRE, len, lineGetter, lineCount, lastLine, logConsole, makeRunner, mixin, modularf, matchGetter, merge, mget, map, mergeOnTop, mergeToObject, mapFilter, noop, nestPush, no, newlineIndent, n2char, objectWalk, overlap, objectToString, opposite, pipe, parseTopAttrs, pascalCase, partition, parens, push, pop, parseJSON, rigidSort, removeQuotes, rep, removeComments, range, removeExtension, rescape, reverse, reWrap, reduceToString, repeatUntil, swapKey, sayhi, swap, splitMapJoin, splitCamel, smallify, search, stringify, shared, smartDedent, stringBreaker, sleep, split, snakeCase, stringArgument, sorted, splitOnce, searchf, secondLine, titleCase, textOrJson, toNumber, toArgument, toNestedArray, test, type, tail, transformObject, trim, testf, toArray, templater, totalOverlap, upperCase, unique, uncapitalize, wrap, walk, wrapf, xsplit, yes, zip2} from "/home/kdog3682/2023/utils.js"

const VOmniInput = {
    name: 'v-omni-input',
    computed: {
        ckey() {
            switch (type(this.value)) {
                case 'Boolean': return 'v-checkbox'
                case 'Number': return 'v-slider'
                default: return 'v-input2'
            }
        },
        ctype() {
            return type(this.value)
        },
    },
    template: `
        <div class="v-omni-input">
            <component :is="ckey" :value="value" @change="$emit('change', value)"/>
            <label>{{label}}</label>
            
        </div>
    `,
    props: [
        'value',
        'label',
    ],
}

const VFzfItem = {
    name: 'v-fzf-item',
    render(h) {
        const selector = (x) => x.name
        // console.log('rendering v-fzf')
        const mapper = (item, positions) => {
        // console.log(item)
            const chars = selector(item).split('')
            const inner = (ch, i) => {
                const has = positions.has(i)
                const style = {
                    color: has ? 'green' : 'null',
                    fontWeight: has ? '800' : 'null',
                }
                return h('span', {style}, ch)
            }
        
            const spans = chars.map(inner)
            const self = this
            return h('li', {
                on: {
                    click() {
                        console.log('hi from render fn fzf-item click')
                        self.$emit('click', item)
                    },
                    keydown(e) {
                        console.log('hi from keydown', e.key)
                    }
                }
            }, spans)
        }
        // console.log(this.item, this.positions)
        return mapper(this.item, this.positions)
    },
    props: [
        'item',
        'positions',
    ],
}

const VFzf = {
    computed: {
        item() {
            const base =  this.items[this.index]
            if (base == null) {
                return
            }
            if ('positions' in base) {
                return base.item
            }
            return base
        },
        config() {
            const runner = (opt) => {
                return [opt.label, opt.value]
            }
            const a = reduce(this.options, runner)
            a.selector = (x) => x.name
            return a
        },
        items() {
            console.log('rendering computed items')
            function pseudofzf(el) {
                return {
                    item: el,
                    positions: new Set()
                }
            }
            
            if (this.fzf) {
                if (this.input) {
                    const matches = this.fzf.find(this.input)
                    // console.log("matches", matches)
                    return matches
                } else {
                    return this.base.map(pseudofzf)
                }
            }  else {
                // console.log('no fzf')
            }
        },
    },
    name: 'v-fzf',
    methods: {
        __click__1() {
            const item = this.items[this.index]
            console.log('hi from top click')
        },
        __keydown__1(e) {
            const ref = {
                'ArrowUp': -1,
                'ArrowDown': 1,
            }
            e.stopPropagation()
            const dir = ref[e.key]
            if (dir) {
                this.$modularIndex('items', dir)
                return
            }
            if (e.key == 'm') {
                console.log('saving this.item', this.item)
                // this.logs.push(this.item)
                this.item.icon = 'howdy'
                // this.icons[this.index] = JSON.stringify(this.item)
                // this.$forceUpdate()
            }
            // console.log('hii')
        },
        __style__1(slot) {
            return {
                background: this.index == slot.index ? 'yellow' : null
            }
        },
        __keydown__2(e) {
            console.log('stopping from the bottom')
            throw 'this doesnt work'
            e.stopPropagation()
        },
        __click__2(slot) {
            // console.log(slot)
            // console.log('aa')
            // console.log(e)
            // console.log(slot)
            this.index = slot.index
        },
        load() {
            try {
                const fzf = new window.fzf(this.base, this.config)
                if (!fzf) {
                    console.log('no fzf')
                    return
                }
                console.log(fzf)
                this.fzf = fzf
            } catch(e) {
                console.log('error', e.toString())
            }
        },
    },
    async mounted() {
        this.base = copy(this.value)
        this.input = 'a'
        this.icons = {}
        this.options = [
            { label: 'sort', value: true, },
            { label: 'limit', value: 10, },
        ]
        
        // this.load()
        
        this.$listen({
            up() {
                this.$modularIndex('items', 1)
            },
            down() {
                this.$modularIndex('items', -1)
            },
            letterKey(key) {
                switch(key) {
                    case 'm':
                        console.log(key)
                }
            }
        })
    },
    watch: {
        config() {
            console.log('watching the config', strftime('datetime'))
            this.load()
        },
    },
    template: `
        <div class="v-fzf">
            <v-input2 v-model="input" focus="false"/>
            <h5>logs</h5>
            
            <v-list :value="logs">
                <template v-slot:default="slot">
                    <v-pre :value="slot"/>
                </template>
            </v-list>
            
            <div v-if="items">
                <v-list :value="saved"/>
                <p>length: {{items.length}}</p>
                <v-list :value="items" @click.native="__click__1" @keydown.native="__keydown__1" ref="list" tabindex="0">
                    <template v-slot:default="slot">
                        <div class="container" :style="__style__1(slot)" @keydown.native="__keydown__2" type="flex" style="display: flex;">
                            <v-fzf-item @click="__click__2(slot)" v-bind="slot.value"/>
                            <div class="container" type="icon" style="tag: span; class: icon;">
                                <span>{{slot.value.item.icon}}</span>
                            </div>
                        </div>
                    </template>
                </v-list>
            </div>
            
            <div v-else>
                <p>no items are present for fzf</p>
            </div>
            
            <v-omni-input v-for="(option, index) in options" v-bind="option" ref="omni"/>
            
        </div>
    `,
    data() {
        return {
            logs: [],
            index: 0,
            base: '',
            input: '',
            icons: [],
            options: [],
            fzf: '',
        }
    },
    props: [
        'value',
        'saved',
        'option',
    ],
}

const VMain = {
    name: 'v-main',
    imports: '/home/kdog3682/2024-javascript/lib/fzf.js',
    async created() {
        this.items = ['abc', 'def', 'aac', 'aaaaaaaaab', 'apple'].map((x) => {
            return {
                icon: 'none',
                name: x,
            }
        })
        console.log('setting up the created', strftime('datetime'))
        // console.log(mod)
        // console.log('hi')
        // window.Fzf=mod.Fzf
    },
    async mounted() {
        await sleep(1000)
        console.log('mounted')
        const fzf = this.$refs.fzf
        // you dont mutate from the bottom
        // everything is top down
        // you want to change the slider ... you change it from the top
        // console.log(fzf.$refs)
        // console.log(fzf.$refs.omni[1].$refs.slider.increment())
        // const list = fzf.$refs.list
        // console.log("list", list)
        // console.log(list.$info('methods'))
        // console.log(fzf.$info('methods'))
        // console.log(Object.keys(list.$options.methods))
        // console.log("list", list)
        return
        fzf.options[1].value += 10
        fzf.item.icon = 'booga'
        await sleep(1000)
        fzf.options[1].value += 10
        await sleep(1000)
        fzf.input = 'pp'
        await sleep(1000)
        fzf.input = 'a'
        return
        console.log("fzf", fzf)
        const el = fzf.items[1].item
        console.log("el", el)
        el.icon = 'howdy'
        await sleep(1500)
        fzf.$modularIndex('items')
        await sleep(1500)
        fzf.$modularIndex('items', -1)
        // you have to premap the items
        // waterfall again
        // prevent ...
        enter()
    },
    template: `
        <div class="v-main">
            <p>hi</p>
            <v-fzf :value="items" ref="fzf"/>
            
        </div>
    `,
    data() {
        return {
            items: [],
        }
    },
}

VMain.el = '#app'
new Vue(VMain)

